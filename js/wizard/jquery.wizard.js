/*
jQuery.wizard v1.0.0-rc2
https://github.com/kflorence/jquery-wizard/
An asynchronous form wizard that supports branching.

Requires:
 - jQuery 1.3.2+
 - jQuery UI widget 1.8.0+

Copyright (c) 2011 Kyle Florence
Dual licensed under the MIT and GPLv2 licenses.
*/

(function(e,t){var n,r=0,i={},s={},o=Array.prototype.slice,u=function(t){return e.isArray(t)?t:[t]},a="id",f="form",l="click",c="submit",h="disabled",p="wizard",d="default",v="number",m="object",g="string",y="boolean",b="afterBackward",w="afterForward",E="afterSelect",S="beforeBackward",x="beforeForward",T="beforeSelect",N="beforeSubmit";e.each("branch form header step wrapper".split(" "),function(){i[this]="."+(s[this]=p+"-"+this)}),e.widget("kf."+p,{version:"1.0.0-rc2",options:{animations:{show:{options:{duration:0},properties:{opacity:"show"}},hide:{options:{duration:0},properties:{opacity:"hide"}}},backward:".backward",branches:".branch",disabled:!1,enableSubmit:!1,forward:".forward",header:":header:first",initialStep:0,stateAttribute:"data-state",stepClasses:{current:"current",exclude:"exclude",stop:"stop",submit:"submit",unidirectional:"unidirectional"},steps:".step",submit:":submit",transitions:{},unidirectional:!1,afterBackward:null,afterForward:null,afterSelect:null,beforeBackward:null,beforeForward:null,beforeSelect:null},_create:function(){var t,n,o=this,l=o.options,c=o.element,h=c.find(l.steps),v=h.eq(0).parent();c[0].elements?t=c:(t=c.find(f)).length||(t=c.closest(f)),(n=c.find(l.header)).length||(n=t.find(l.header)),o.elements={form:t.addClass(s.form),submit:t.find(l.submit),forward:t.find(l.forward),backward:t.find(l.backward),header:n.addClass(s.header),steps:c.find(l.steps).hide().addClass(s.step),branches:c.find(l.branches).add(v).addClass(s.branch),stepsWrapper:v.addClass(s.wrapper),wizard:c.addClass(p)},v.attr(a)||v.attr(a,p+"-"+ ++r),o.elements.forward.click(function(e){e.preventDefault(),o.forward(e)}),o.elements.backward.click(function(e){e.preventDefault(),o.backward(e)}),o._currentState={branchesActivated:[],stepsActivated:[]},o._stepCount=o.elements.steps.length,o._lastStepIndex=o._stepCount-1,o._branchLabels=[],o.elements.steps.each(function(t){o._branchLabels[t]=e(this).parent().attr(a)}),o._excludesFilter=function(){return!e(this).hasClass(l.stepClasses.exclude)},l.transitions[d]||(l.transitions[d]=function(e){return o.stepIndex(e.nextAll(i.step))}),o.select.apply(o,u(l.initialStep))},_fastForward:function(n,r,i){var s=0,o=this,u=o._currentState.stepIndex,a=[u];e.isFunction(r)&&(i=r,r=t),function f(){o._transition(u,function(t,l){if((u=o.stepIndex(t,l))===-1)throw new Error('[_fastForward]: Invalid step "'+t+'"');if(e.inArray(u,a)>=0)throw new Error('[_fastForward]: Recursion detected on step "'+t+'"');a.push(u),u===o._lastStepIndex||(r?++s:u)===n?i.call(o,u,a):f()})}()},_find:function(n,r,i){var s,o,a,f,l=[],c=r instanceof jQuery?r:e(r);if(n!=t&&c.length){n=u(n);for(s=0,o=n.length;s<o;s++){var h;a=n[s],f=typeof a,f===v?h=c.get(a):f===g?h=document.getElementById(a.replace("#","")):f===m&&(a instanceof jQuery&&a.length&&(a=a[0]),a.nodeType&&c.each(function(){if(this===a)return(h=this)&&!1})),h&&l.push(h)}}return i===!1?l:e(l)},_move:function(n,r,i,s,o){function f(n,r){o.call(u,n,e.isArray(s)?s:s!==!1?r:t)}var u=this,a=u._currentState;typeof r===y&&(o=s,s=i,i=r,r=t),i===!0?n>0?u._fastForward(n,i,f):o.call(u,a.stepsActivated[Math.max(0,n+(a.stepsActivated.length-1))]):(n=u.stepIndex(n,r))!==-1&&(n>a.stepIndex?u._fastForward(n,f):f.call(u,n))},_state:function(t,n){if(!this.isValidStepIndex(t))return null;var r=this.options,s=e.extend(!0,{},this._currentState);n=u(n||t),s.step=this.elements.steps.eq(t),s.branch=s.step.parent(),s.branchStepCount=s.branch.children(i.step).length,s.isMovingForward=t>s.stepIndex,s.stepIndexInBranch=s.branch.children(i.step).index(s.step);var o,a,f,l=0,c=n.length;for(;l<c;l++)t=n[l],o=this._branchLabels[t],!s.stepIndex||s.stepIndex<t?e.inArray(t,s.stepsActivated)<0&&(s.stepsActivated.push(t),e.inArray(o,s.branchesActivated)<0&&s.branchesActivated.push(o)):s.stepIndex>t&&(a=e.inArray(o,s.branchesActivated)+1,f=e.inArray(t,s.stepsActivated)+1,a>0&&s.branchesActivated.splice(a,s.branchesActivated.length-1),f>0&&s.stepsActivated.splice(f,s.stepsActivated.length-1)),s.stepIndex=t,s.branchLabel=o;return s.stepsComplete=Math.max(0,this._find(s.stepsActivated,this.elements.steps).filter(this._excludesFilter).length-1),s.stepsPossible=Math.max(0,this._find(s.branchesActivated,this.elements.branches).children(i.step).filter(this._excludesFilter).length-1),e.extend(s,{branchLabel:this._branchLabels[t],isFirstStep:t===0,isFirstStepInBranch:s.stepIndexInBranch===0,isLastStep:t===this._lastStepIndex,isLastStepInBranch:s.stepIndexInBranch===s.branchStepCount-1,percentComplete:100*s.stepsComplete/s.stepsPossible,stepsRemaining:s.stepsPossible-s.stepsComplete}),s},_transition:function(n,r,i){var s=this;e.isFunction(n)?(i=n,n=s._currentState.stepIndex,r=t):e.isFunction(r)&&(i=r,r=t);var a,f=s.options,l=s.step(n,r),c=l.attr(f.stateAttribute),h=c?f.transitions[c]:f.transitions[d];return e.isFunction(h)?a=h.call(s,l,function(){return i.apply(s,o.call(arguments))}):a=c,a!==t&&a!==!1&&i.apply(s,u(a)),a},_update:function(t,n){var r=this._currentState,i=this.options;if(r.step){if(i.disabled||!n||n.stepIndex===r.stepIndex||!this._trigger(T,t,n)||n.isMovingForward&&!this._trigger(x,t,n)||!n.isMovingForward&&!this._trigger(S,t,n))return;r.step.removeClass(i.stepClasses.current).animate(i.animations.hide.properties,e.extend({},i.animations.hide.options))}this._currentState=n,n.step.addClass(i.stepClasses.current).animate(i.animations.show.properties,e.extend({},i.animations.show.options)),n.isFirstStep||i.unidirectional||n.step.hasClass(i.stepClasses.unidirectional)?this.elements.backward.attr(h,!0):this.elements.backward.removeAttr(h),n.isLastStepInBranch&&!n.step.attr(i.stateAttribute)||n.step.hasClass(i.stepClasses.stop)?this.elements.forward.attr(h,!0):this.elements.forward.removeAttr(h),i.enableSubmit||n.step.hasClass(i.stepClasses.submit)?this.elements.submit.removeAttr(h):this.elements.submit.attr(h,!0),r.step&&(this._trigger(E,t,n),this._trigger(n.isMovingForward?w:b,t,n))},backward:function(e,n){typeof e===v&&(n=e,e=t),n===t&&(n=1);if(this._currentState.isFirstStep||typeof n!==v)return;this._move(-n,!0,!1,function(t,n){this._update(e,this._state(t,n))})},branch:function(e){return arguments.length?this._find(e,this.elements.branches):this._currentState.branch},branches:function(e){return arguments.length?this.branch(e).children(i.branch):this.elements.branches},branchesActivated:function(){return this._find(this._currentState.branchesActivated,this.elements.branches)},destroy:function(){var t=this.elements;this.element.removeClass(p),t.form.removeClass(s.form),t.header.removeClass(s.header),t.steps.show().removeClass(s.step),t.stepsWrapper.removeClass(s.wrapper),t.branches.removeClass(s.branch),e.Widget.prototype.destroy.call(this)},form:function(){return this.elements.form},forward:function(e,n,r){typeof e===v&&(r=n,n=e,e=t),n===t&&(n=1);if(this._currentState.isLastStep||typeof n!==v)return;this._move(n,!0,r,function(t,n){this._update(e,this._state(t,n))})},isValidStep:function(e,t){return this.isValidStepIndex(this.stepIndex(e,t))},isValidStepIndex:function(e){return typeof e===v&&e>=0&&e<=this._lastStepIndex},length:function(){return this._stepCount},select:function(n,r,i,s,o){n instanceof e.Event||(o=s,s=i,i=r,r=n,n=t);if(r==t)return;e.isArray(r)?(o=s,s=i,i=r[1],r=r[0]):typeof i===y?(o=s,s=i,i=t):e.isArray(i)&&(o=i,i=t),this._move(r,i,s,o,function(e,t){this._update(n,this._state(e,t))})},state:function(n,r,i){return arguments.length?(e.isArray(n)?(i=r,r=n[1],n=n[0]):e.isArray(r)&&(i=r,r=t),this._state(this.stepIndex(n,r),i)):this._currentState},step:function(n,r){if(!arguments.length)return this._currentState.step;e.isArray(n)&&(r=n[1],n=n[0]);var i,o=typeof n;return o===v?i=this._find(n,r!==t?this.steps(r):this.elements.steps):(i=this._find(n,this.elements.steps.add(this.elements.branches)),i&&i.hasClass(s.branch)&&(i=this._find(r||0,this.steps(i)))),i},stepIndex:function(n,r,s){if(!arguments.length)return this._currentState.stepIndex;var o;return e.isArray(n)?(s=r,r=n[1],n=n[0]):typeof r===y&&(s=r,r=t),(o=this.step(n,r))?(s?o.siblings(i.step).andSelf():this.elements.steps).index(o):-1},steps:function(e){return arguments.length?this.branch(e).children(i.step):this.elements.steps},stepsActivated:function(){return this._find(this._currentState.stepsActivated,this.elements.steps)},submit:function(){this.elements.form.submit()}})})(jQuery);